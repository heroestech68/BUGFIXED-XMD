const express = require("express");
const { default: makeWASocket, useMultiFileAuthState, fetchLatestBaileysVersion } = require("@whiskeysockets/baileys");
const cors = require("cors");
const fs = require("fs");
const bodyParser = require("body-parser");

const app = express();
app.use(cors());
app.use(bodyParser.json());
app.use(express.static("public"));

app.get("/generate", async (req, res) => {
  try {
    const { state, saveCreds } = await useMultiFileAuthState("auth_info");
    const { version } = await fetchLatestBaileysVersion();

    const sock = makeWASocket({
      version,
      printQRInTerminal: false,
      auth: state
    });

    sock.ev.on("connection.update", async (update) => {
      const { pairingCode, connection } = update;

      if (pairingCode) {
        res.json({ pairingCode });
      }

      if (connection === "open") {
        console.log("Connected!");

        await saveCreds();

        // Read generated creds.json
        const credsJson = fs.readFileSync("auth_info/creds.json", "utf8");

        // Convert to JS export file
        const credsJs =
          "module.exports = " + credsJson + ";";

        fs.writeFileSync("auth_info/creds.js", credsJs);

        res.json({
          success: true,
          credsJs: credsJs
        });

        process.exit(0);
      }
    });

  } catch (err) {
    res.json({ error: err.message });
  }
});

app.listen(3000, () => console.log("Pairing site running on port 3000"));
