// script.js - pairing logic + UI
const $ = id => document.getElementById(id);

const phoneInput = $('phone');
const submitBtn = $('submitBtn');
const statusText = $('statusText');
const pairingArea = $('pairingArea');
const pairingCodeEl = $('pairingCode');
const actions = $('actions');
const downloadCreds = $('downloadCreds');

const playBtn = $('playBtn');
const audio = $('audio');

let sessionId = null;
let pollHandle = null;

function makeSessionId() {
  // timestamp + random to avoid collisions
  return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
}

function setLoading(on) {
  if (on) {
    submitBtn.disabled = true;
    submitBtn.style.opacity = 0.7;
    statusText.textContent = 'Starting session...';
  } else {
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
  }
}

async function startSession() {
  const phone = phoneInput.value.trim();
  if (!phone) { alert('Enter phone number with country code'); phoneInput.focus(); return; }

  sessionId = makeSessionId();
  setLoading(true);
  pairingArea.style.display = 'none';
  actions.style.display = 'none';
  pairingCodeEl.textContent = '';

  try {
    const res = await fetch('/api/start-session', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ sessionId, phoneNumber: phone })
    });

    const j = await res.json();
    if (!j || j.success !== true) {
      statusText.textContent = 'Server error while starting session';
      setLoading(false);
      return;
    }

    statusText.textContent = 'Session started — waiting for pairing code';
    // start polling status
    pollHandle = setInterval(pollStatus, 2000);
  } catch (err) {
    console.error(err);
    statusText.textContent = 'Network error: ' + (err.message || err);
    setLoading(false);
  }
}

async function pollStatus() {
  if (!sessionId) return;
  try {
    const res = await fetch(`/api/status/${sessionId}`);
    const j = await res.json();

    if (!j || j.exists === false) {
      statusText.textContent = 'Session not found on server';
      return;
    }

    // show pairing code if present
    if (j.pairingCode) {
      pairingArea.style.display = 'block';
      pairingCodeEl.textContent = j.pairingCode;
      statusText.textContent = 'Pairing code generated — enter it in WhatsApp';
    } else {
      statusText.textContent = 'Waiting for pairing code...';
    }

    // when creds are ready (connected)
    if (j.credsReady) {
      statusText.textContent = 'Pairing complete — creds ready';
      clearInterval(pollHandle);
      actions.style.display = 'flex';
      downloadCreds.href = `/api/download-creds/${sessionId}`;
      downloadCreds.download = `creds-${sessionId}.json`;
      setLoading(false);
    }
  } catch (err) {
    console.error('poll error', err);
    statusText.textContent = 'Server poll error';
  }
}

// audio controls
playBtn.addEventListener('click', () => {
  if (audio.paused) {
    audio.play();
    playBtn.textContent = '⏸';
  } else {
    audio.pause();
    playBtn.textContent = '▶';
  }
});

submitBtn.addEventListener('click', startSession);

// allow enter key to submit
phoneInput.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') startSession();
});
